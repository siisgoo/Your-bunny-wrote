var __awaiter=this&&this.__awaiter||function(n,s,e,t){function o(t){return t instanceof e?t:new e(function(e){e(t)})}return new(e||(e=Promise))(function(a,i){function r(n){try{e(t.next(n))}catch(e){i(e)}}function c(n){try{e(t.throw(n))}catch(e){i(e)}}function e(e){e.done?a(e.value):o(e.value).then(r,c)}e((t=t.apply(n,s||[])).next())})};const baseUrl=document.location.origin,VERSION="v0.1.2 beta",botName="Tech-bot "+VERSION;let lastMessageId=0,chatHistory=[],chatHash,managerRequired=!1;const updateManagersInterval=1e4;let onWaitManager=!1,pollUpdatesInterval=1e3,pollUpdatesTimer,onEnteringName=!1,whileSending=!1,chatToggleStillHovered=!1,chatToggleAlreadyOpened=!1;const botMessages={startup:()=>appendMessage({from:"b",text:"Я - tech-bot."}),enterName:()=>appendMessage({from:"b",text:"Как к вам обращаться?"}),returnToManager:()=>appendMessage({from:"b",text:"Тут я бессилен, вызываю оператора."}),waitForManager:()=>appendMessage({from:"b",text:"Пожалуйста, подождите, вам скоро ответят."},!1),chatClosed:()=>appendMessage({from:"b",text:"Чат закрыт, надеюсь мы помогли вам."}),managerLeaved:()=>appendMessage({from:"b",text:"Менеджер вышел из чата, ищем вам другого."}),historyTurnDelete:()=>appendMessage({from:"b",text:"Сообщения больше не будут сохраняться в историю"},!1),historyTurnSave:()=>appendMessage({from:"b",text:"Сообщения будут сохраняться в историю"},!1),internalError:()=>appendMessage({from:"b",text:"Ой-ой. Что то пошло не так, пожалуйста, презагрузите страницу."}),whatBotCan:()=>appendMessage({text:"Я умею:</br>Вызывать оператора</br>...В разработке...",from:"b"}),botCommands:()=>appendMessage({text:"Чем буду полезен?",from:"b",buttons:[{name:"Список возможностей",value:"_showWhatBotCan"},{name:"Вызвать оператора",value:"_callManager"}]})};jQuery.fn.onPositionChanged=function(s,o){o==null&&(o=100);var t,n,e=$(this[0]);return e.length<1?e:(t=null,n=null,setInterval(function(){if(e==null||e.length<1)return e;t==null&&(t=e.position()),n==null&&(n=e.offset());var o=e.position(),i=e.offset();(t.top!=o.top||t.left!=o.left)&&($(this).trigger("onPositionChanged",{lastPos:t,newPos:o}),typeof s=="function"&&s(t,o),t=e.position()),(n.top!=i.top||n.left!=i.left)&&($(this).trigger("onOffsetChanged",{lastOff:n,newOff:i}),typeof s=="function"&&s(n,i),n=e.offset())},o),e)};function appendMessage(e,n=!0){switch(e.from){case"m":{e.creator==null&&(e.creator="Менеджер"),e.avatarPath="/techbot/images/avatars/"+e.managerId,e.type="user";break}case"b":{e.creator=botName,e.avatarPath="/techbot/images/avatars/bot-icon.png",e.type="user";break}case"c":{getCookie("customerName")?e.creator=getCookie("customerName"):e.creator="Customer",e.avatarPath="/techbot/images/avatars/user-icon.png",e.type="self";break}default:{console.log("appendMessage: passed unknown msgFrom value - ",e.from);return}}e.time==null&&(e.time=(new Date).getTime());let s=new Date(e.time).toLocaleTimeString();lastMessageId++,e.id=lastMessageId,n===!0&&chatHistory.push(e);let t="<div id='cm-msg-"+e.id+"' class=\"chat-msg "+e.from+" "+e.type+'">'+'<span class="msg-avatar">'+'<img src="'+e.avatarPath+'">'+"</span>"+'<div class="cm-msg-text">'+e.text+'<div class="cm-msg-time">'+s+"</div>"+"</div>";return e.buttons&&(t+='<div class="cm-msg-button"><ul>'+e.buttons.map(e=>'<li class="button"><span onclick="handleButtonClick(\''+e.name+"','"+e.value+"', '"+lastMessageId+'\')" class="chat-button"">'+e.name+"</span>"+"</li>").join('')+"</ul>"+"</div>"),t+="</div>",$("#chat-logs").append(t),$("#cm-msg-"+lastMessageId).hide().fadeIn(300),$("#chat-logs").stop().animate({scrollTop:$("#chat-logs")[0].scrollHeight},1e3),e}function saveChatHistory(){localStorage.setItem("chatHistory",JSON.stringify(chatHistory))}function loadChatHistory(){let e=localStorage.getItem("chatHistory");if(e)if(chatHistory=JSON.parse(e),chatHistory.length>0){if(chatHistory.forEach(e=>appendMessage(e,!1)),getCookie("managerName")){let e=getCookie("chatHash");e?(chatHash=e,$("#chat-manager-name").text(getCookie("managerName")),managerRequired=!0,onWaitManager=!1,startPolling(pollUpdatesInterval)):returnToBot()}}else returnToBot();else returnToBot()}function resetChat(){disconnectFromManager(),localStorage.removeItem("chatHistory"),lastMessageId=0,chatHistory=[],deleteCookie("chatHash"),chatHash=null,deleteCookie("customerName"),deleteCookie("managerName"),$(".chat-msg").each(function(){$(this).remove()}),returnToBot()}function getCookie(t){let e=document.cookie.match(new RegExp("(?:^|; )"+t.replace(/([.$?*|{}()[\]\\/+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0}function setCookie(n,s,e={}){e={Path:"/",Secure:!0,SameSite:"none"};let t=encodeURIComponent(n)+"="+encodeURIComponent(s);for(let n in e){t+="; "+n;let s=e[n];s!==!0&&(t+="="+s)}document.cookie=t}function deleteCookie(e){setCookie(e,"",{Expires:new Date(-1).toUTCString()})}function startPolling(){pollUpdatesTimer=setInterval(function(){pollUpdates()},pollUpdatesInterval)}function stopPolling(){clearInterval(pollUpdatesTimer)}function updateManagersCount(){$.ajax({url:baseUrl+"/techbot/service/actions/getOnline.php",type:"GET",async:!0,timeout:updateManagersInterval-10}).done(e=>{$("#chat-managers-online-num").text(e),chatToggleAlreadyOpened||adjustChatToggle()})}function pollUpdates(){let e={chatHash};$.ajax({url:baseUrl+"/techbot/service/actions/pollUpdates.php",type:"GET",dataType:"JSON",data:e,async:!0,timeout:pollUpdatesInterval}).done(function(e){switch(e.status){case"ok":switch(e.info){case"closed":deleteCookie("managerName"),botMessages.chatClosed(),returnToBot(!1);const t=new Audio("/techbot/new_message_sound.mp3");t.play();break;case"pending":if(!onWaitManager){deleteCookie("managerName"),botMessages.managerLeaved(),returnToBot(!1),returnToManager();const e=new Audio("/techbot/new_message_sound.mp3");e.play()}break;case"inchat":if(onWaitManager){setCookie("managerName",e.newManagerName),$("#chat-manager-name").text(e.newManagerName),onWaitManager=!1;const t=new Audio("/techbot/new_message_sound.mp3");t.play()}break;default:console.log("Unknown result by tbGetMessages.php: ",e);return}if(e.msgs&&e.msgs.length>0){$.each(e.msgs,function(t,e){e.from=="m"&&appendMessage(e)});const t=new Audio("/techbot/new_message_sound.mp3");t.play()}return!0;break;case"error":console.log(e),console.log("FAIL "+e.status),console.log("INFO "+e.info),e.error=="bad_chHash"&&(chatHash=null,deleteCookie("chatHash"),setTimeout(pollUpdates,1e3));break;default:alert("Что то сломалось, перезагрузите страницу");break}}).fail(function(e,t){console.log("FAIL "+t),console.log(e)})}function sendMessage(e){whileSending=!0;const t={message:e,chatHash};$.ajax({url:baseUrl+"/techbot/service/actions/sendMessage.php",type:"POST",dataType:"JSON",data:t,async:!0,timeout:25e3}).done(function(e){whileSending=!1,e.status=="ok"||e.status=="error"&&console.log("Error while sending message: ",e)}).fail(function(e,t){whileSending=!1,console.log("failed"),console.log(e),console.log(t)})}function disconnectFromManager(){if(managerRequired){let e={chatHash};$.ajax({url:baseUrl+"/techbot/service/actions/closeSession.php",type:"POST",dataType:"JSON",data:e,async:!1}).fail(e=>console.log(e))}}function returnToManager(){managerRequired=!0,onWaitManager=!0;let e={chatHash:getCookie("chatHash")};$.ajax({url:baseUrl+"/techbot/service/actions/requestManager.php",type:"POST",dataType:"JSON",data:e,async:!0,timeout:60*1e3}).done(e=>{chatHash=e.chatHash,setCookie("chatHash",e.chatHash,{Secure:!0}),chatHistory.forEach(e=>{sendMessage(e)}),startPolling(pollUpdatesInterval)}).fail((e,t)=>{console.log("FAIL "+t),console.log(e),botMessages.internalError()})}function returnToBot(e=!0){e&&botMessages.startup(),stopPolling(),$("#chat-manager-name").text(botName),managerRequired=!1,onWaitManager=!1,whileSending=!1,getCookie("customerName")?botMessages.botCommands():(botMessages.enterName(),onEnteringName=!0)}let smartcmp=(e,t)=>e==t;function faqSearch(){return null}function handleButtonClick(e,t,n){switch($("#cm-msg-"+n+" .cm-msg-button").remove(),appendMessage({text:e,from:"c"}),t){case"_callManager":appendMessage({text:"Вызываю оператора",from:"b"}),returnToManager();break;case"_showWhatBotCan":botMessages.whatBotCan();break}}function handleUserInput(){let e=$("#chat-input").val();if(e.length>0&&whileSending!=!0){let t=appendMessage({from:"c",text:e});if($("#chat-input").val(''),managerRequired)onWaitManager&&botMessages.waitForManager(),sendMessage(t);else if(onEnteringName)setCookie("customerName",e),onEnteringName=!1,botMessages.botCommands();else{let t=faqSearch(e);t!=null?appendMessage(t):(botMessages.returnToManager(),returnToManager())}}}class DragDrop{constructor(e,t,n=$("body")){this.Active=!1,this.OffsetX=0,this.OffsetY=0,this.item=e,this.target=t,this.container=n,this.OffsetX=e.position().left,this.OffsetY=e.position().top,this.item.onPositionChanged(this.updateOffset.bind(this)),this.container.on("touchstart",this.dragStart.bind(this)),this.container.on("touchend",this.dragEnd.bind(this)),this.container.on("touchmove",this.drag.bind(this)),this.container.on("mousedown",this.dragStart.bind(this)),this.container.on("mouseup",this.dragEnd.bind(this)),this.container.on("mousemove",this.drag.bind(this))}dragStart(e){e.type==="touchstart"?(this.InitialX=e.touches[0].clientX-this.OffsetX,this.InitialY=e.touches[0].clientY-this.OffsetY):(this.InitialX=e.clientX-this.OffsetX,this.InitialY=e.clientY-this.OffsetY),e.target===this.target[0]&&($("html").addClass("-is-locked"),this.item.removeClass("drag-notactive"),this.item.addClass("drag-active"),this.Active=!0)}dragEnd(){this.InitialX=this.CurrentX,this.InitialY=this.CurrentY,this.Active=!1,$("html").removeClass("-is-locked"),this.item.removeClass("drag-active"),this.item.addClass("drag-notactive")}updateOffset(e){this.OffsetX=e.left,this.OffsetY=e.top}drag(e){this.Active&&(e.preventDefault(),e.type==="touchmove"?(this.CurrentX=e.touches[0].clientX-this.InitialX,this.CurrentY=e.touches[0].clientY-this.InitialY):(this.CurrentX=e.clientX-this.InitialX,this.CurrentY=e.clientY-this.InitialY),this.OffsetX=this.CurrentX,this.OffsetY=this.CurrentY,this.item.css("left",this.CurrentX),this.item.css("top",this.CurrentY))}}function chatToggleNormalLeft(){return $("#chat-toggle-text").width()-$("#chat-toggle").width()+4}function adjustChatToggle(e=0){$("#chat-toggle").animate({left:chatToggleNormalLeft()},e)}function setTranslate(e,t,n,s=0){n.animate({left:e,top:t},s)}function setupChatMovement(){const n=$("#chat-box").position(),o=$("#chat-box").position().left,i=-$("#chat-box").width()-o,a=$("#chat-box").height();let t={hidden:!1,visible:!0},e=!1;$("#chat-toggle").hover(t=>{let e=()=>$("#chat-toggle").stop().animate({left:0},1500,"easeInOutQuint");chatToggleStillHovered=!0,chatToggleAlreadyOpened?(chatToggleAlreadyOpened=!0,e()):setTimeout(()=>{chatToggleStillHovered&&(chatToggleAlreadyOpened=!0,e())},1050)},e=>{chatToggleStillHovered=!1,$("#chat-toggle").stop().animate({left:chatToggleNormalLeft()},2e3,"easeOutCubic",()=>{chatToggleAlreadyOpened=!1})}),$("#chat-toggle-text").on("click",e=>{t.hidden?(t.hidden=!1,t.visible=!0,$("#chat-box").stop(),$("#chat-box").animate({left:o,top:n.top,height:"toggle",width:"toggle"},1e3,"easeOutQuad")):(t.hidden=!0,t.visible=!1,$("#chat-box").stop(),$("#chat-box").animate({left:i,top:n.top,height:"toggle",width:"toggle"},1e3,"easeOutQuad"))});function s(e,t=0,n=null){$("#chat-logs").animate({height:e.height-$("#chat-box-header")[0].offsetHeight-$("#chat-input")[0].offsetHeight},t,n),$("#chat-box").animate({width:e.width,height:e.height},t,n)}s({width:$("#chat-box").width(),height:$("#chat-box").height()}),$("#chat-vertical-normal").css("display","none"),$("#chat-vertical-maximize").on("click",function(){e||(e=!0,$(this).css("display","none"),$("#chat-vertical-normal").css("display","block"),$("#chat-box").animate({top:0,left:6},500,()=>{s({width:$("#chat-box").width(),height:window.innerHeight},1e3,()=>{e=!1})}))}),$("#chat-vertical-normal").on("click",function(){e||(e=!0,$("#chat-vertical-maximize").css("display","block"),$(this).css("display","none"),s({width:$("#chat-box").width(),height:a},1e3,()=>$("#chat-box").animate({top:n.top,left:n.left},500,()=>{e=!1})))})}function setup(){new DragDrop($("#chat-box"),$("#chat-box-header")),$("#chat-input").bind("keyup",e=>{e.keyCode==13&&handleUserInput(e)}),$("#chat-submit").on("click",()=>{let e=new WebSocket("ws://38f1-185-253-102-98.ngrok.io/ws");e.onopen=t=>{e.send("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")}});let e=getCookie("chatBackground");if(e)$("#chat-box-body").css("background-image",e);else{let e=(e,t)=>Math.round(Math.random()*(t-e)+e);$("#chat-box-body").css("background-image","url(/techbot/images/backgrounds/chat-background-"+e(1,$("#chat-background-count").attr("data"))+".png)")}getCookie("saveChatSession")=="true"?($("#chat-save-session").addClass("chat-settings-active"),loadChatHistory()):(setCookie("saveChatSession","false"),$("#chat-save-session").addClass("chat-settings-diactive"),returnToBot()),$("#chat-save-session").on("click",()=>{getCookie("saveChatSession")=="true"?(setCookie("saveChatSession","false"),$("#chat-save-session").removeClass("chat-settings-active"),$("#chat-save-session").addClass("chat-settings-diactive"),botMessages.historyTurnDelete()):(setCookie("saveChatSession","true"),$("#chat-save-session").removeClass("chat-settings-diactive"),$("#chat-save-session").addClass("chat-settings-active"),botMessages.historyTurnSave())}),$("#chat-reset").on("click",()=>resetChat()),$("#chat-box").animate({opacity:1},1e3),$("#chat-toggle").css("left",-$("#chat-toggle").width()),adjustChatToggle(1e3),updateManagersCount(),setInterval(updateManagersCount,updateManagersInterval),setupChatMovement()}window.onload=()=>__awaiter(this,void 0,void 0,function*(){return setup()}),window.onunload=()=>{getCookie("saveChatSession")=="false"?resetChat():saveChatHistory()}