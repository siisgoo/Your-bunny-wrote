# Описание
## Терминология
- Администратор - человек, владеющий всеми правами на использование чат-бота телеграм
- Менеджер - человек, обладающий доступом к чат-боту, основной задачей которого является принятие запроса на создание соединения с Счатом и диалог с человеком из Счата
- Тчат - чат с ботом телеграм, в котором состоит менеджер
- Счат - чат на странице веб-сайта
- сервер - ПО, связывающее Тчат и Счат
## Общие возможности
Обмен текстовыми сообщениями между Счатом и Тчатом и реакция на введенные запросы на стороне Счата определенными скриптами.
## Метод работы
На стороне клиента(Счат) ведется только обработка входящих сообщений и отправка введенных.
Это делает архитектуру Счат простой и позволяет вводить новые "фитчи" без изменения Счата.
Основную задачу выполняет сервер, принимает новые подключения от Счатов, создает соединение можду Счатом и Тчатом, и хранит все необходимые данные, и поддерживает работу чат-бота телеграм.
Сервер и Счат соединяются по средствам веб-сокетов.
В данной версии ПС доступ к серверу осуществляется через прокси-сервис localtunnel.
## Возможные нововведения
- Поддержка обменом медиа файлами
- Автоматические ответы по базе данных FQA
- Управление Счатом с помощью команд
- Клавиатура для управления Тчатом
# Администрирование
В данном разделе бедет преведено описание принципов администрирования чат-сервиса.
## Подготовка к запуску
### Сервер
Сервер работает на платформе nodeJS для поддержания крос-платформености проекта.
Для этого необходимо установить последнюю версию nodeJS и npm для целевой ОС.
> При использования версии nodeJS менее v16, TODO
Для запуска необходимо скачать последнюю версию ПС, для этого перейдите по ссылке на (https://github.com/siisgoo/rediirector)[репозиторий github] и по нажатию на кнопку Code в выпадающем меню скачайте архив, либо воспользуйтесь программой git:
```bash
git clone "https://github.com/siisgoo/rediirector"
```
После перейдите в директорию server и наберите данную последовательность команд для сборки проекта:
```bash
cd /path/to/rediirector/server
npm install
npm run build
```
#### Конфигурация
Для запуска необходимо внести изменения в файл config.sample.json и после переименовать его в config.json.
Общий вид файла конфигурации:
```json
{
    "bot": {
        "token": "1111111113:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAs",
        "admin_id": 111111111
    },

    "server": {
        "database": {
            "saveChatHistory": true,
            "path": "storage/database"
        },
        "fileStorage": {
            "public_path": "storage/public",
            "path": "storage/public/files"
        },
        "port": 7900,
        "subdomain": "rediirector",
        "domain": "rediirector"
    }
}
```

Описание настроек в формате: имя - описание (тип данных)
bot:
- token - токен телеграм бота (/^[0-9]{8,10}:[a-zA-Z0-9_-]{35}$/)
- admin_id - id профиля телеграм (number)

server:
- database
    - saveChatHistory - необходмо ли сохранять сообщения и чаты после завершения програмы сервера (boolean)
    - path - путь к папке в которую будут сохраняться фалы баз данных (string)
- fileStorage
    - public_path - путь к папке с общедоступными файлами(настрайка устарела, оставте значение равное path) (string)
    - path - путь к папке с файлами (string)
- port - порт на котором будет работать сервер (number)
- subdomain - поддомен для работы localtunnel (string)
- domain - доменое имя сервиса(не работает в данных, необходима платная подписка) (string)

Все поля являются обязательными к заполнению
#### Запуск
Для запуска введите и корневой директории сервера:
```bash
npm run start
```
##### Сообщения об ошибках
- Server already running. Process PID: 12345. __Решение__: asdf
- StructError: At path: some.path.to.error.key -- Expected a string matching SOME MISS MATCH __Решение__: свертесь с шаблоном конфигурации текущую конфигуращию и внесите изменения в поле с путем some.path.to.error.key
- Config parse error: SOME ERROR MSG __Решение__: проверте формат записи в файле конфигурации в соответствии с сообщение об ошибке
- Directory DIRNAME not writable for user USERNAME. __Решение__: добавте права на запись пользователю USERNAME в директории DIRNAME
- LT error: ERROR MESSAGE __Решение__: Возможно - нет доступа к интернету...
- Cannot initialize chat service. Subdomain: SOMESUBDOMAIN is busy __Решение__: подождите некоторое время, пока под-домен не станет свободен, либо измените под-домен в файле конфигурации и на хостинге, как описанно в разделе "Чат на веб-сайте(Счат) > Конфигурирование"
### Чат на веб-сайте(Счат)
Счат предназначен для установки на хостинге.
Обновление Счата на хостинге происходит в 2 шага - компиляция новой версии и выкладывание файлов на хостинг:
Компиляция:
Перейдите в корневую деректорию Счата и введите данную последовательность команд:
```bash
cd /path/to/rediirector/hosting-side
npm install
npm build
```
#### Конфигурирование
Счат содержит одно поле для конфигурации - адрес сервера, т.к. в данной версии ПС сервер не использует статичный адрес, а распространяет свой адресс с помощью прокси-сервиса.
Для конфигурации измените заначение "edit-me", в файле /path/to/rediirector/hosting-side/src/chat.ts, на значение subdomain в конфигурационном фале сервера и пересоберите проект:
```js

...

$(document).ready(function() {
    model = new Model(new URL("wss://edit-me.loca.lt/ws")); // << - edit me!
    let controler = new Controller(model);
    let view = new View(model);

...

```
#### Обновление/установка чата на хостинг
Для устаноки или обновления иходников чата на стороне хостинга необходимо рекурсивно скопировать директорию /path/to/rediirector/hosting-side/public на хостинг в корневую директорию public-данных, затем переименуйте директорию, как, по вашему мнению, удобнее.
#### Добавление чата на веб-страницу
Для добавления чата на веб страницу необходимо добавить следующий контент в файл целевой веб-страницы:
В блок <head></head> добавте, где CHAT_ROOT - директория, в которой находятся файлы Счата:
```html
<head>
...
    <script type="module" src="/CHAT_ROOT/js/chat.js"></script>
    <link rel="stylesheet" href="/CHAT_ROOT/chat.css" type="text/css">
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.2/bootstrap-material-design.css" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" type="text/css">
...
</head>
```
В блок <body></body> добавте следующий код, где CHAT_ROOT - директория, в которой находятся файлы Счата:
```html
<body>
...
    <?php include $_SERVER["DOCUMENT_ROOT"] . "/CHAT_ROOT/chat.php" ?>
...
</body>
```
## Управление контентом
Статичный контент Счата - это изображения на заднем фоне и изображения портретов бота и клиента.

Для внесения изменений в здних фонах чата, перейдите в /path/to/rediirector/hosting-side/public/images/backgrounds и внесите изменения, нет необходимости соблюдать "нейминг" файлов, наличие файлов заднего фона не является обезательным.
Для изменения портретов бота или пользователя замение файлы bot-icon.png и user-icon.png соответствено, файлы находятся в /path/to/rdiirector/hosting-side/public/images/avatars, имена файлов должы оставаться неизменными.
# Использование чат-сервиса
Под чат-сервисом понимается телеграм бот.
## Общие понятия
При первом запуске сервера, в системе будет зарегестрирован только один пользователь - администратор, id которого соответствует введенному значению admin_id в конфигурационном файле сервера. Добавление нового пользователя в систему происходит по схеме запроса доступа у администратора с помощью отправки запроса при нажатии на кнопку "Send", прикрепленному к сообщению о предложении отправки запроса на подтверждение личности. После нажатия на кнопку "Send" администратор получит сообщение с двумя кнопками(Approve и Reject), предлогающее принять заявку или отклонить ее. При нажатии на кнопку "Approve" пользователь будет зарегистрирован в системе как менеджер и получит доступ к сервисам бота.

При запуске и остановке сервера каждый авторизованный пользователь бота получит сообщение об этом событии.

К каждому пользователю чат сервиса присоединяется маркер статуса, принемающий два значения - "online" или "offline". Изначально для каждого маркер в состоянии "offline". Перейти в другой режим можно командами /goonline и /gooffline. При остановке сервера всем причесляется статус "offline". Узнать текущий статус можно с помощью команды /status.

При отправки сообщения будучи не подключенным к Счату, сообщение будет удалено.
## Управление профилем
Каждый авторизованный пользователь может установит себе имя, которое будет отображаться на стороне Счата с помощью команды /setname New Name, где "New Name" любые символы.
Также, можно обновить свой портрет с помощью команды /updateavatar, ваш стандартный портрет будет заменен на текущее изобращение в профиле телеграм.
> В дальнейших версиях будет добавлена функция обновления портрета, используя любое пользовательское изображение.
## Соединение и итарация с Счатом
При запросе на создания чат-сессии от Счата, каждый пользователь телеграм-бота со статусом "online" получит приглашение на соединение с Счатом. При переходе из стратуса "offline" в "online" инициатор получит список всех ожидающих Счатов, если они имеются.
При переходе по приглашению в диалог с Счатом все ваши сообщения будут пересылаться в Счат и из Счата вы так же будите получать все сообщения, кроме управляющих последовательностей(команд).

При разрыве соединения с Счатом, менеджер прикрепленный к данному Счату получит сообщение о дальнейшем статусе чата, это либо сообщение о том, что Счат был закрыт по инициативе собеседника или сообщение о возможном продолжении сессии.
### Допустимые сообщения при взаимодействии с Счатом
- Любые символы(plaintext) и emoji
- Команды чат-бота
### Не обрабатываемые возможности чатов телеграм
- пересылка(forward) сообщений
- ответ(reply) на сообщение
- обработка сообщений в markdown формате
- редактирование сообщений
- отправка медиа файлов
- отправка голосовых сообщений
- отслеживание текущего действия собеседника
## Управление активным Счатом
Получить полную историю чата можно с помощью команды /history.
Активный Счат можно закрыть и покинуть.
При закрытии чата, Счат будет переведен под управление бота и может заного подать заявку на соединение с Тчатом.
При покидании чата, Счат будет помечен как ждущий ответа и все остальным менеджерам будет послано приглашение на соединение с Счатом.
## Список команд
Общие:
- /start
- /chats (в разработке)
- /menu (в разработке)
Управление профилем:
- /setname New User Name
- /updateavatar
- /goonline
- /gooffline
- /status
Управление чатами:
- /history
- /enterchat xxxx-xxxx-xxxx-xxxx
- /leave
- /close
